---
title: "DRAFT -- TECHNICAL MEMORANDUM"
subtitle: "<b>TO: </b> Christine Nordahl, Olivia, Andy <br> <b> FROM: </b> Matt Ponzini, Sandra Taylor <br> <b> SUBJECT:</b> APP/GAIN Multivariate Longitudinal Clustering <br> <b>DATE:</b> `r paste0(' ', Sys.Date())`"
output: 
  bookdown::html_document2:
    number_sections: TRUE
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
---

<style type="text/css">

h1.title {
  font-size: 24px;
  font-weight: bolder;
}

h1 { /* Header 1 */
  font-size: 16px;
  font-weight: bold;
}

h2 { /* Header 2 */
  font-size: 14px;
  font-weight: bold;
}

h3 { /* Header 3 */
  font-size: 13px;
  font-weight: bold;
}

h3.subtitle { /* Header 3 Subtitle */
  font-size: 20px;
  font-weight: normal;
  line-height: 150%;
}

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)

# load packages
pacman::p_load(dplyr, tibble, tidyr, gtsummary, ggplot2, cowplot,
               lcmm, BCClong, kml3d)

# update 'asis' chunk to allow inline code
knitr::knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knitr::knit_child(text = options$code)
})
  

internal <- FALSE
```

<hr style="height:1px;color:black;background-color:black">

```{r data-import, include=internal}
# if data import file(s) is (are) large, consider caching the data
#   see https://bookdown.org/yihui/rmarkdown-cookbook/cache.html for more 
#   information
source("../R/kmeans_helpers.R")
# import data and results #
brain_regions <- c(
  "Type2.L3.Frontal_L_prop", 
  "Type2.L3.Frontal_R_prop", 
  "Type2.L3.Parietal_L_prop", 
  "Type2.L3.Parietal_R_prop",
  "Type2.L3.Occipital_L_prop", 
  "Type2.L3.Occipital_R_prop", 
  "Type2.L3.Temporal_L_prop", 
  "Type2.L3.Temporal_R_prop"
)
# data
brain_vol <- readRDS(file = "./data-ext/brain_vol_long_20241219.rds")
brain_vol_wide <- readRDS(file = "./data-ext/brain_vol_prop_wide_20241219.rds")
# lcmm results
lcmm_k2 <- readRDS(file = "./data-ext/lcmm_k2_visit_proportions.rds")
lcmm_k3 <- readRDS(file = "./data-ext/lcmm_k3_visit_proportions.rds")
lcmm_k4 <- readRDS(file = "./data-ext/lcmm_k4_visit_proportions.rds")
# bcc results
bcc_fits <- readRDS(file = "./data-ext/bcc_models_k2-4_hemispheres.rds")
# kmeans results
set.seed(649)
kml_fit <- kmeans_clusters(dataset = brain_vol_wide)
```

# Multivariate Longitudinal Clustering of Brain Volumes  

Exploration of multivariate longitudinal clustering of brain region volumes using three different approaches:

-   Latent Class Mixed effect Model (LCMM) using the {lcmm} package (version `r packageVersion('lcmm')`)  
-   Bayesian Consensus Clustering (BCC) using the {BCClong} package (version `r packageVersion('BCClong')`)  
-   K-means mulitvariate longitudinal clustering (KML) using the {kml3d} package (version `r packageVersion('kml3d')`)  

The brain region volumes include frontal, parietal, temporal, and occipital for each hemisphere. Volumes are converted to proportion of hemispheric volume to adjust for overall brain volume.  

# Latent Class Mixed effect Model (LCMM)  

```{r lcmm, include=internal}
# determine number of clusters
lcmm_bic <- c(lcmm_k2$BIC, lcmm_k3$BIC, lcmm_k4$BIC)
lcmm_k <- which.min(lcmm_bic) + 1
# get posterior cluster probability of assignment
lcmm_postprob <- apply(lcmm_k3$pprob[,-c(1,2)], 1, max)
# relabel cluster
lcmm_cluster <- lcmm_k3$pprob$class
# keep last obs per id
brain_lcmm_uq <- brain_vol[!duplicated(brain_vol$subj_id_numeric, fromLast = TRUE),]
brain_lcmm_uq <- brain_lcmm_uq |> 
  dplyr::mutate(
    postprob = lcmm_postprob,
    cluster = lcmm_cluster
  )

lcmm_plot <- ggplot(
  brain_lcmm_uq, aes(x=factor(cluster), y=postprob)
) +
  geom_boxplot() + 
  ggtitle("Latent Class Mixed Model") +
  xlab("Clusters") + 
  ylab("Posterior Cluster Probability") +
  ylim(c(0,1)) +
  scale_y_continuous(label = scales::percent) +
  theme_bw() +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 15, face = "bold"),
    axis.text=element_text(size=15),
    axis.title=element_text(size=15),
    axis.text.x = element_text(angle = 0 ),
    strip.text.x = element_text(size = 15, angle = 0),
    strip.text.y = element_text(size = 15,face="bold")
  )

lcmm_n <- brain_vol |> dplyr::pull(subj_id_numeric) |> unique() |> length()
lcmm_per <- paste(round(100*table(lcmm_cluster)/lcmm_n,1),"%",sep="")

lcmm_cluster_labels <- factor(
  lcmm_cluster, 
  label = glue::glue(
    "Cluster {1:lcmm_k} ({lcmm_per})"
  )
)

brain_lcmm_long <- brain_vol |> 
  dplyr::left_join(
    x = _,
    y = data.frame(subj_id_numeric = brain_lcmm_uq$subj_id_numeric,
                   cluster = lcmm_cluster_labels)
  ) |> 
  dplyr::select(
    subj_id_numeric, visit, cluster, 
    Type2.L3.Frontal_L_prop, Type2.L3.Frontal_R_prop, 
    Type2.L3.Parietal_L_prop, Type2.L3.Parietal_R_prop,
    Type2.L3.Occipital_L_prop, Type2.L3.Occipital_R_prop, 
    Type2.L3.Temporal_L_prop, Type2.L3.Temporal_R_prop
  ) |>
  tidyr::pivot_longer(
    cols = c(
      Type2.L3.Frontal_L_prop, Type2.L3.Frontal_R_prop, 
      Type2.L3.Parietal_L_prop, Type2.L3.Parietal_R_prop,
      Type2.L3.Occipital_L_prop, Type2.L3.Occipital_R_prop, 
      Type2.L3.Temporal_L_prop, Type2.L3.Temporal_R_prop
    ),
    values_to = "volume",
    names_to = "region"
  ) |> 
  dplyr::mutate(
    region = dplyr::case_when(
      region == "Type2.L3.Frontal_L_prop" ~ "Frontal, Left", 
      region == "Type2.L3.Frontal_R_prop" ~ "Frontal, Right", 
      region == "Type2.L3.Parietal_L_prop" ~ "Parietal, Left", 
      region == "Type2.L3.Parietal_R_prop" ~ "Parietal, Right",
      region == "Type2.L3.Occipital_L_prop" ~ "Occipital, Left", 
      region == "Type2.L3.Occipital_R_prop" ~ "Occipital, Right", 
      region == "Type2.L3.Temporal_L_prop" ~ "Temporal, Left", 
      region == "Type2.L3.Temporal_R_prop" ~ "Temporal, Right"
    )
  )

lcmm_cluster_volumes <- brain_lcmm_long |> 
  ggplot() +
  aes(x = factor(visit), y = volume, color = cluster, group = cluster) +
  geom_smooth(method = "loess", se = FALSE, span = 1.5, linewidth = 2.5) +
  scale_y_continuous(expand = expansion(mult = 0.25)) +
  guides(color = guide_legend(title = "Cluster")) +
  facet_wrap(~region, scales = "free", ncol = 2) +
  labs(x = "Visit", y = "Proportional Volume") +
  theme_bw() +
  theme(
    legend.position = "bottom"
  )

```

```{r}
lcmm_plot
```

```{r, fig.height = 12, fig.width=8, warning=FALSE, message=FALSE}
lcmm_cluster_volumes
```

# Bayesian Consensus Clustering (BCC)

```{r bcc-number-k, include=internal}
alpha_adjust <- lapply(bcc_fits, function(x) x$alpha.adjust) |>  unlist()
bcc_k <- which.max(alpha_adjust) + 1

data.frame(
  k = seq(2, 4, by = 1),
  `Adjusted Alpha` = alpha_adjust,
  check.names = FALSE
) |>
  ggplot2::ggplot() +
  ggplot2::aes(x = k, y = `Adjusted Alpha`) +
  ggplot2::geom_point() +
  ggplot2::geom_line() +
  ggplot2::labs(x = '*k*', y = 'Mean adjusted adherence') +
  ggplot2::theme_bw() +
  ggplot2::theme(
    axis.title.x = ggtext::element_markdown()
  )
```

```{r bcc-post-prob, include=internal}
dat <- bcc_fits[[bcc_k]]$dat
dat1_uq <- dat[[1]][!duplicated(dat[[1]]$id.org, fromLast = TRUE), ]
dat1_uq$post_prob <- bcc_fits[[bcc_k]]$postprob
```

# K-Means Multivariate Longitudinal Clustering (KML)

```{r}
kml_data <- brain_vol |> 
  dplyr::left_join(
    x = _,
    y = kml_fit |> dplyr::select(subj_id, cluster),
    by = "subj_id"
  ) |> 
  dplyr::filter(!is.na(cluster))
```

```{r kml-number-cluster, include=internal}
kml_bic <- data.frame(
  Cluster = 2:5,
  BIC = attr(kml_fit, "BIC")
)

kml_bic |> 
  ggplot() +
  aes(x = Cluster, y = BIC) +
  geom_point() +
  geom_line() +
  theme_bw()
```

```{r, warning=FALSE, message=FALSE}
kml_feature_plots <- lapply(
  brain_regions,
  function(x) plot_kmean_feature(data = kml_data, var = x)
)
```

```{r, fig.height = 10, fig.width = 10}
cowplot::plot_grid(
  plotlist = kml_feature_plots[1:4]
)
```

```{r, fig.height = 10, fig.width = 10}
cowplot::plot_grid(
  plotlist = kml_feature_plots[5:8]
)
```

# Compare Cluster Assignments

```{r combine-clusters}
brain_clusters <- brain_lcmm_uq |> 
  dplyr::select(subj_id_numeric, cluster) |> 
  dplyr::rename(lcmm_cluster = cluster) |> 
  dplyr::left_join(
    x = _,
    y = ,
    by = "subj_id_numeric"
  ) |> 
  dplyr::left_join(
    x = _,
    y = ,
    by = "subj_id_numeric"
  )
```